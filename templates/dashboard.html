{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block head_extra %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
    <style>
      /* --- Streak Box Visualization --- */
      #streak-boxes-container {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        padding: 10px 0;
        margin-bottom: 1rem;
      }

      .streak-box {
        width: 15px;
        height: 15px;
        background-color: rgba(255, 255, 255, 0.1);
        border: 1px solid #333;
        border-radius: 2px;
      }

      .streak-box.filled {
        background-color: #00ff87;
        border-color: #00e676;
      }
    </style>
{% endblock %}

{% block content %}
    <h1>ðŸ“Š Skill Tracker Dashboard</h1>

    <div id="dashboard-content" class="hidden">
        <div id="streak-boxes-container"></div>
        
        <div class="chart-container">
            <canvas id="topicChart"></canvas>
        </div>
        <p id="streakText"></p>
        <p id="currentStreakText"></p>
    </div>

    <div id="loading-state" class="status-message">Loading dashboard data...</div>
    <div id="error-state" class="status-message hidden">Failed to load data. Please try again later.</div>

    <script>
      // Self-invoking async function to use await
      (async () => {
        const dashboardContent = document.getElementById('dashboard-content');
        const loadingState = document.getElementById('loading-state');
        const errorState = document.getElementById('error-state');

        dashboardContent.classList.add('hidden');
        loadingState.classList.remove('hidden');
        errorState.classList.add('hidden');

        try {
          const response = await fetch('/analytics_data');
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const data = await response.json();

          // --- Create Streak Boxes ---
          const streakContainer = document.getElementById('streak-boxes-container');
          const totalBoxes = 30; // Show a total of 30 boxes (e.g., for a monthly goal)
          
          streakContainer.innerHTML = ''; // Clear any existing boxes
          for (let i = 1; i <= totalBoxes; i++) {
              const box = document.createElement('div');
              box.classList.add('streak-box');
              if (i <= data.currentStreak) {
                  box.classList.add('filled');
              }
              streakContainer.appendChild(box);
          }
          
          // Create the topic chart and update streak text
          createTopicChart(data.topicCounts);
          document.getElementById('streakText').innerText = `ðŸ”¥ Longest Streak: ${data.longestStreak} days`;
          document.getElementById('currentStreakText').innerText = `âš¡ Current Streak: ${data.currentStreak} days`;

          dashboardContent.classList.remove('hidden');
          loadingState.classList.add('hidden');

        } catch (error) {
          console.error('Error fetching analytics data:', error);
          errorState.classList.remove('hidden');
          loadingState.classList.add('hidden');
        }
      })();

      function createTopicChart(topicData) {
        const ctx = document.getElementById('topicChart').getContext('2d');
        new Chart(ctx, {
          type: 'pie',
          data: {
            labels: Object.keys(topicData),
            datasets: [{
              label: 'Topic Frequency',
              data: Object.values(topicData),
              backgroundColor: ['#00e676', '#1de9b6', '#64ffda', '#69f0ae', '#76ff03']
            }]
          },
          options: {
            responsive: true,
            plugins: {
              title: { display: true, text: 'Topic Distribution' }
            }
          }
        });
      }
    </script>
{% endblock %}