{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block head_extra %}
<script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cal-heatmap@3.6.2/cal-heatmap.css">
{% endblock %}

{% block content %}
<h1>ðŸ“Š Skill Tracker Dashboard</h1>

<div id="dashboard-content" class="hidden">
  <div id="cal-heatmap"></div>
  <hr>

  <div class="chart-container">
    <canvas id="topicChart"></canvas>
  </div>
  <p id="streakText"></p>
  <p id="currentStreakText"></p>
</div>

<div id="loading-state" class="status-message">Loading dashboard data...</div>
<div id="error-state" class="status-message hidden">Failed to load data. Please try again later.</div>

<script src="https://d3js.org/d3.v3.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/cal-heatmap@3.6.2/cal-heatmap.min.js"></script>

<script>
  // Self-invoking async function to use await
  (async () => {
    const dashboardContent = document.getElementById('dashboard-content');
    const loadingState = document.getElementById('loading-state');
    const errorState = document.getElementById('error-state');

    // Hide content, show loading indicator
    dashboardContent.classList.add('hidden');
    loadingState.classList.remove('hidden');
    errorState.classList.add('hidden');

    try {
      const response = await fetch('/analytics_data');
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      const data = await response.json();

      // Initialize the Heatmap
      const cal = new CalHeatMap();
      cal.init({
        itemSelector: "#cal-heatmap",
        domain: "month",
        subDomain: "day",
        data: data.heatmap_data,
        start: new Date(2025, 6), // Start in July
        cellSize: 15,
        range: 5,
        legend: [1],
        legendColors: {
          // This is the critical part that sets the color
          min: "#00ff87",
          max: "#00c46a",
          empty: "rgba(255, 255, 255, 0.1)"
        }
      });

      // Create the topic chart and update streak text
      createTopicChart(data.topicCounts);
      document.getElementById('streakText').innerText = `ðŸ”¥ Longest Streak: ${data.longestStreak} days`;
      document.getElementById('currentStreakText').innerText = `âš¡ Current Streak: ${data.currentStreak} days`;

      // Show content, hide loading indicator
      dashboardContent.classList.remove('hidden');
      loadingState.classList.add('hidden');

    } catch (error) {
      console.error('Error fetching analytics data:', error);
      // Show error message, hide loading indicator
      errorState.classList.remove('hidden');
      loadingState.classList.add('hidden');
    }
  })();

  function createTopicChart(topicData) {
    const ctx = document.getElementById('topicChart').getContext('2d');
    new Chart(ctx, {
      type: 'pie',
      data: {
        labels: Object.keys(topicData),
        datasets: [{
          label: 'Topic Frequency',
          data: Object.values(topicData),
          backgroundColor: ['#00e676', '#1de9b6', '#64ffda', '#69f0ae', '#76ff03']
        }]
      },
      options: {
        responsive: true,
        plugins: {
          title: { display: true, text: 'Topic Distribution' }
        }
      }
    });
  }
</script>
{% endblock %}