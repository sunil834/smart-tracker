{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block head_extra %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block body_content %}
<div class="nav-links">
    <a href="/">üè† Home</a>
    <a href="/progress">üìò Progress</a>
    <a href="/tracker">üìÖ Tracker</a>
    <a href="/ctf">üêû CTF</a>
</div>

<div class="calendar-dashboard">
    <div class="month-header">
        <h1>üìä Skill Tracker Dashboard</h1>
        
        <!-- Streak badge -->
        <div id="streak-badge" class="streak-badge hidden">
            ‚ö° Current Streak: <span id="streak-count">0</span> days
        </div>
        
        <select id="month-selector" class="month-dropdown">
            <!-- Options will be populated by JavaScript -->
        </select>
    </div>
    
    <div class="calendar-container">
        <div class="calendar-header">
            <div class="day-header">Sun</div>
            <div class="day-header">Mon</div>
            <div class="day-header">Tue</div>
            <div class="day-header">Wed</div>
            <div class="day-header">Thu</div>
            <div class="day-header">Fri</div>
            <div class="day-header">Sat</div>
        </div>
        
        <div class="calendar-grid" id="activity-calendar">
            <!-- Calendar days will be generated by JavaScript -->
        </div>
    </div>
    
    <div class="dashboard-stats">
        <div class="stat-card">
            <div class="stat-number" id="current-streak">0</div>
            <div class="stat-label">Current Streak</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="longest-streak">0</div>
            <div class="stat-label">Longest Streak</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="total-days">0</div>
            <div class="stat-label">Total Active Days</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="this-month">0</div>
            <div class="stat-label">This Month</div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentYear = new Date().getFullYear();
    let currentMonth = new Date().getMonth();
    let activityData = {};
    
    function initializeMonthSelector() {
        const selector = document.getElementById('month-selector');
        const months = [
            'January', 'February', 'March', 'April', 'May', 'June',
            'July', 'August', 'September', 'October', 'November', 'December'
        ];
        
        // Clear existing options
        selector.innerHTML = '';
        
        // Add options for current year and previous year
        for (let year = currentYear; year >= currentYear - 1; year--) {
            const endMonth = year === currentYear ? currentMonth : 11;
            for (let month = endMonth; month >= 0; month--) {
                const option = document.createElement('option');
                option.value = `${year}-${month}`;
                option.textContent = `${months[month]} ${year}`;
                if (year === currentYear && month === currentMonth) {
                    option.selected = true;
                }
                selector.appendChild(option);
            }
        }
        
        selector.addEventListener('change', function() {
            const [year, month] = this.value.split('-').map(Number);
            currentYear = year;
            currentMonth = month;
            generateCalendar();
            updateMonthlyStats();
        });
    }
    
    function generateCalendar() {
        const calendarContainer = document.getElementById('activity-calendar');
        const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
        const firstDayOfWeek = new Date(currentYear, currentMonth, 1).getDay();
        
        // Clear existing calendar
        calendarContainer.innerHTML = '';
        
        // Add empty cells for days before month starts
        for (let i = 0; i < firstDayOfWeek; i++) {
            const emptyDay = document.createElement('div');
            emptyDay.className = 'calendar-day empty';
            calendarContainer.appendChild(emptyDay);
        }
        
        // Add days of the month
        for (let day = 1; day <= daysInMonth; day++) {
            const dateString = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const hasActivity = activityData[dateString] || false;
            
            const dayElement = document.createElement('div');
            dayElement.className = `calendar-day ${hasActivity ? 'active' : 'inactive'}`;
            dayElement.textContent = day;
            
            // Mark today
            const today = new Date();
            if (currentYear === today.getFullYear() && 
                currentMonth === today.getMonth() && 
                day === today.getDate()) {
                dayElement.classList.add('today');
            }
            
            dayElement.addEventListener('click', () => {
                document.querySelectorAll('.calendar-day').forEach(d => d.classList.remove('selected'));
                dayElement.classList.add('selected');
            });
            
            calendarContainer.appendChild(dayElement);
        }
    }
    
    function updateMonthlyStats() {
        const thisMonthCount = Object.keys(activityData).filter(date => {
            const dateObj = new Date(date);
            return dateObj.getFullYear() === currentYear && dateObj.getMonth() === currentMonth;
        }).length;
        document.getElementById('this-month').textContent = thisMonthCount;
    }
    
    function updateStreakBadge(currentStreak) {
        const streakBadge = document.getElementById('streak-badge');
        const streakCount = document.getElementById('streak-count');
        
        if (currentStreak >= 2) {
            streakCount.textContent = currentStreak;
            streakBadge.classList.remove('hidden');
        } else {
            streakBadge.classList.add('hidden');
        }
    }
    
    function loadAnalyticsData() {
        fetch('/analytics_data')
            .then(response => response.json())
            .then(data => {
                console.log('Analytics data loaded:', data);
                
                // Process activity data
                activityData = data.activity_map || {};
                
                // Update stats
                const currentStreak = data.currentStreak || 0;
                const longestStreak = data.longestStreak || 0;
                const totalActiveDays = Object.values(activityData).filter(Boolean).length;
                
                document.getElementById('current-streak').textContent = currentStreak;
                document.getElementById('longest-streak').textContent = longestStreak;
                document.getElementById('total-days').textContent = totalActiveDays;
                
                // Update streak badge
                updateStreakBadge(currentStreak);
                
                // Generate calendar and update monthly stats
                generateCalendar();
                updateMonthlyStats();
            })
            .catch(error => {
                console.error('Error loading analytics data:', error);
                generateCalendar(); // Still show calendar even if data fails
            });
    }
    
    // Initialize everything
    initializeMonthSelector();
    loadAnalyticsData();
});
</script>

<style>
/* Additional CSS for streak badge */
.streak-badge {
    background-color: var(--primary-color);
    color: var(--bg-color);
    padding: 8px 16px;
    border-radius: 20px;
    font-weight: bold;
    font-size: 1.1em;
    margin: 10px auto;
    display: inline-block;
    box-shadow: 0 2px 8px rgba(0, 255, 135, 0.3);
}

.streak-badge.hidden {
    display: none;
}
</style>
{% endblock %}
